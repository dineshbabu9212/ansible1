---
  - hosts: localhost

    tasks:
    - name: get the application name
      set_fact:
        appname: "{{ APP_NAME.split(':')[1:] }}"

    - name: setiing facts from service now
      set_fact:
        date_time: "{{ST_DATE| replace('-','')|replace(':','')|replace(' ','')}}"

    - name: get the date and time
      set_fact:
        date: "{{ date_time[:8]}}"
        time: "{{ date_time[8:]}}"


    - name: Build a schedule for Demo Job Template
      awx.awx.schedule:
        controller_host: 'http://139.59.37.96/'
        controller_password: 'password'
        controller_username: 'admin'
        name: 'FROM SNOW {{ CHG_NO }}{{item}}'
        state: present
        unified_job_template: "Patch"
        rrule: "DTSTART;TZID=US/Central:{{date}}T{{time}} RRULE:FREQ=YEARLY;INTERVAL=0;COUNT=1"
        extra_data:
          servers_list: "{{ item }}"
          changeno: "{{ CHG_NO }}"
#          st_date: "{{ST_DATE}}"
      with_items: "{{appname}}"
      register: result
    - name: debug
      debug:
        msg: "{{ result }}"
